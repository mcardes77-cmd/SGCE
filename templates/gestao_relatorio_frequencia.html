<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Relatório de Frequência</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex flex-col">

  <!-- Cabeçalho -->
  <header class="text-center py-6 border-b border-gray-700">
    <h1 class="text-2xl sm:text-3xl font-bold text-yellow-400">SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR</h1>
    <h2 class="text-lg sm:text-xl text-gray-300 mt-2">RELATÓRIO DE FREQUÊNCIA MENSAL</h2>
  </header>

  <!-- Botão voltar -->
  <div class="flex justify-center mt-4">
    <a href="/gestao_ocorrencia" 
       class="bg-gray-700 hover:bg-gray-600 text-white font-semibold px-6 py-2 rounded-2xl transition">
      VOLTAR AO MENU
    </a>
  </div>

  <!-- Filtros -->
  <main class="flex-grow flex flex-col items-center p-4">
    <div class="bg-gray-800 rounded-2xl shadow-lg p-6 w-full max-w-lg mt-6">
      <div class="space-y-4">
        <div>
          <label class="block text-gray-300 mb-1">Sala</label>
          <select id="sala" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-gray-200"></select>
        </div>

        <div>
          <label class="block text-gray-300 mb-1">Mês</label>
          <select id="mes" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-gray-200">
            <option value="1">Janeiro</option>
            <option value="2">Fevereiro</option>
            <option value="3">Março</option>
            <option value="4">Abril</option>
            <option value="5">Maio</option>
            <option value="6">Junho</option>
            <option value="7">Julho</option>
            <option value="8">Agosto</option>
            <option value="9">Setembro</option>
            <option value="10" selected>Outubro</option>
            <option value="11">Novembro</option>
            <option value="12">Dezembro</option>
          </select>
        </div>

        <button onclick="visualizarFrequencia()"
                class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-2 rounded-lg transition">
          Visualizar Frequência
        </button>

        <div id="erro" class="text-red-500 text-center mt-2 hidden">
          Erro ao carregar os dados. Verifique o console.
        </div>
      </div>
    </div>

    <!-- Tabela -->
    <div id="tabela-frequencia" class="mt-8 w-full max-w-6xl overflow-x-auto"></div>
  </main>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 bg-black bg-opacity-70 hidden justify-center items-center">
    <div class="bg-gray-800 p-6 rounded-2xl shadow-lg w-11/12 max-w-md">
      <h3 class="text-lg font-bold text-yellow-400 mb-3">Detalhes do Registro</h3>
      <div id="modal-conteudo" class="text-gray-200 space-y-1"></div>
      <button onclick="fecharModal()" 
              class="mt-4 w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 rounded-lg">
        Fechar
      </button>
    </div>
  </div>

  <!-- Rodapé -->
  <footer class="text-center text-xs text-gray-400 py-4 border-t border-gray-700 mt-auto">
    DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES<br>
    LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
  </footer>

  <script>
    document.addEventListener("DOMContentLoaded", carregarSalas);

    async function carregarSalas() {
      try {
        const response = await fetch("/api/salas");
        const salas = await response.json();

        const select = document.getElementById("sala");
        select.innerHTML = "<option value=''>Selecione uma sala</option>";

        salas.forEach(sala => {
          const option = document.createElement("option");
          option.value = sala.id;
          option.textContent = sala.nome || sala.descricao || `Sala ${sala.id}`;
          select.appendChild(option);
        });
      } catch (error) {
        console.error("Erro ao carregar salas:", error);
        document.getElementById("erro").classList.remove("hidden");
      }
    }

    async function visualizarFrequencia() {
      const salaId = document.getElementById("sala").value;
      const mes = document.getElementById("mes").value;

      if (!salaId || !mes) {
        alert("Selecione uma sala e um mês!");
        return;
      }

      try {
        const res = await fetch(`/api/frequencia?sala_id=${salaId}&mes=${mes}`);
        const data = await res.json();

        if (data.error) throw new Error(data.error);

        document.getElementById("erro").classList.add("hidden");
        renderizarTabelaFrequencia(data, mes);
      } catch (error) {
        console.error("Erro ao carregar frequência:", error);
        document.getElementById("erro").classList.remove("hidden");
      }
    }

    function renderizarTabelaFrequencia(frequencias, mes) {
      const container = document.getElementById("tabela-frequencia");
      container.innerHTML = "";

      const diasUteis = gerarDiasUteis(mes);
      const alunos = agruparPorAluno(frequencias);

      let tabela = `
        <table class="min-w-full border border-gray-600 text-center text-sm text-gray-200">
          <thead class="bg-gray-800 text-yellow-400">
            <tr>
              <th class="border border-gray-600 px-2 py-1">Aluno</th>
              ${diasUteis.map(d => `<th class="border border-gray-600 px-2 py-1">${d.getDate()}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
      `;

      for (const alunoId in alunos) {
        const alunoFrequencias = alunos[alunoId];
        tabela += `<tr><td class="border border-gray-600 px-2 py-1 text-left">${alunoFrequencias.nome || alunoId}</td>`;

        diasUteis.forEach(dia => {
          const registro = alunoFrequencias.registros.find(r => r.data === dia.toISOString().split("T")[0]);
          let conteudo = "";
          let cor = "";

          if (registro) {
            if (registro.status === "P") cor = "bg-green-600 text-white";
            else if (registro.status === "F") cor = "bg-red-600 text-white";
            else if (["PA", "PS", "PSA"].includes(registro.status)) {
              cor = "bg-yellow-500 text-black cursor-pointer";
              conteudo = `<a onclick="abrirModal('${JSON.stringify(registro).replace(/"/g, '&quot;')}')">${registro.status}</a>`;
            }
            if (!conteudo) conteudo = registro.status;
          }

          tabela += `<td class="border border-gray-600 px-2 py-1 ${cor}">${conteudo || ""}</td>`;
        });

        tabela += `</tr>`;
      }

      tabela += "</tbody></table>";
      container.innerHTML = tabela;
    }

    function gerarDiasUteis(mes) {
      const ano = 2025;
      const dias = [];
      const feriados = ["2025-10-27", "2025-11-20"];
      const ultimoDia = new Date(ano, mes, 0).getDate();

      for (let d = 1; d <= ultimoDia; d++) {
        const data = new Date(ano, mes - 1, d);
        const diaSemana = data.getDay();
        const dataStr = data.toISOString().split("T")[0];
        if (diaSemana !== 0 && diaSemana !== 6 && !feriados.includes(dataStr)) {
          dias.push(data);
        }
      }
      return dias;
    }

    function agruparPorAluno(frequencias) {
      const alunos = {};
      frequencias.forEach(f => {
        if (!alunos[f.fk_aluno_id]) {
          alunos[f.fk_aluno_id] = { nome: f.nome_aluno || `Aluno ${f.fk_aluno_id}`, registros: [] };
        }
        alunos[f.fk_aluno_id].registros.push({
          data: f.created_at.split("T")[0],
          status: f.status,
          ...f
        });
      });
      return alunos;
    }

    function abrirModal(infoStr) {
      const info = JSON.parse(infoStr);
      const conteudo = document.getElementById("modal-conteudo");
      conteudo.innerHTML = `
        <p><strong>Status:</strong> ${info.status}</p>
        ${info.hora_atraso ? `<p><strong>Hora Atraso:</strong> ${info.hora_atraso}</p>` : ""}
        ${info.motivo_atraso ? `<p><strong>Motivo Atraso:</strong> ${info.motivo_atraso}</p>` : ""}
        ${info.hora_saida ? `<p><strong>Hora Saída:</strong> ${info.hora_saida}</p>` : ""}
        ${info.motivo_saida ? `<p><strong>Motivo Saída:</strong> ${info.motivo_saida}</p>` : ""}
      `;
      document.getElementById("modal").classList.remove("hidden");
      document.getElementById("modal").classList.add("flex");
    }

    function fecharModal() {
      document.getElementById("modal").classList.add("hidden");
      document.getElementById("modal").classList.remove("flex");
    }
  </script>
</body>
</html>
