<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agendamento de Tutoria</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY = 'SUA_CHAVE_ANON';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let selectedAlunoId = null;

// ===============================
// CARREGAR TUTORES
// ===============================
async function loadTutores() {
    const selectTutor = document.getElementById('filter-tutor');
    selectTutor.innerHTML = '<option value="">SELECIONE O TUTOR</option>';

    const { data: tutores, error } = await supabase.from('d_tutores').select('id,nome');
    if (error) { console.error(error); return; }

    tutores.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(tutor=>{
        const option = document.createElement('option');
        option.value = tutor.id;
        option.textContent = tutor.nome;
        selectTutor.appendChild(option);
    });
    loadAlunos();
}

// ===============================
// CARREGAR ALUNOS POR TUTOR
// ===============================
async function loadAlunos() {
    const tutorId = document.getElementById('filter-tutor').value;
    const selectAluno = document.getElementById('filter-aluno');
    selectedAlunoId = null;

    selectAluno.innerHTML = '<option value="">SELECIONE O ALUNO</option>';
    selectAluno.disabled = !tutorId;

    if (!tutorId) return;

    const { data: alunos, error } = await supabase.from('d_alunos').select('id,nome').eq('tutor_id', tutorId);
    if (error) { console.error(error); return; }

    alunos.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(aluno=>{
        const option = document.createElement('option');
        option.value = aluno.id;
        option.textContent = aluno.nome;
        selectAluno.appendChild(option);
    });
}

// ===============================
// SELEÇÃO DO ALUNO
// ===============================
function selectAluno() {
    const alunoId = document.getElementById('filter-aluno').value;
    selectedAlunoId = alunoId;
    loadHistorico();
}

// ===============================
// CARREGAR HISTÓRICO DE AGENDAMENTOS
// ===============================
async function loadHistorico() {
    const tableBody = document.getElementById('historico-body');
    tableBody.innerHTML = '';
    if (!selectedAlunoId) return;

    const { data: agendamentos, error } = await supabase
        .from('f_frequencia')
        .select('*')
        .eq('aluno_id', selectedAlunoId)
        .order('data_registro', { ascending: true });

    if (error) { console.error(error); return; }
    if (!agendamentos || agendamentos.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Nenhum agendamento encontrado.</td></tr>';
        return;
    }

    agendamentos.forEach((ag, index)=>{
        const row = `<tr class="border-b border-gray-700 hover:bg-dark-primary/50 cursor-pointer" onclick="openAgendamento(${index})">
                        <td class="p-2 text-center">${ag.data_registro?.slice(0,10) || ''}</td>
                        <td class="p-2 text-center">${ag.tipo_atendimento || ''}</td>
                        <td class="p-2 text-left">${ag.descricao_atendimento || ''}</td>
                        <td class="p-2 text-center">${ag.status_agendamento || ''}</td>
                    </tr>`;
        tableBody.insertAdjacentHTML('beforeend', row);
    });

    window.agendamentosLoaded = agendamentos; // Armazena globalmente para edição
}

// ===============================
// ABRIR AGENDAMENTO
// ===============================
function openAgendamento(index) {
    const ag = window.agendamentosLoaded[index];
    if (!ag) return;

    document.getElementById('tipo-atendimento').value = ag.tipo_atendimento || '';
    document.getElementById('descricao-atendimento').value = ag.descricao_atendimento || '';
    document.getElementById('status-agendamento').value = ag.status_agendamento || 'pendente';
}

// ===============================
// SALVAR NOVO AGENDAMENTO
// ===============================
async function salvarAgendamento(e){
    e.preventDefault();
    if (!selectedAlunoId) return alert('Selecione um aluno!');

    const tipo = document.getElementById('tipo-atendimento').value;
    const descricao = document.getElementById('descricao-atendimento').value;
    const status = 'pendente';
    const tutorId = document.getElementById('filter-tutor').value;

    const { data, error } = await supabase.from('f_frequencia')
        .insert([{
            aluno_id: selectedAlunoId,
            tutor_id: tutorId,
            data_registro: new Date().toISOString(),
            tipo_atendimento: tipo,
            descricao_atendimento: descricao,
            status_agendamento: status
        }]);

    if (error) { console.error(error); alert('Erro ao salvar agendamento'); return; }
    alert('Agendamento salvo com sucesso!');
    document.getElementById('descricao-atendimento').value = '';
    loadHistorico();
}

document.addEventListener('DOMContentLoaded', ()=>{
    loadTutores();
});
</script>
<style>
body{background-color:#0F172A;color:#F8FAFC;font-family:'Inter',sans-serif;}
.form-input{width:100%;padding:.75rem;border-radius:.5rem;background-color:#1E293B;color:#F8FAFC;border:1px solid #4b5563;}
</style>
</head>
<body class="bg-dark-primary">
<div class="flex flex-col items-center min-h-screen p-4 md:p-8">

<header class="w-full text-center mb-8">
<h1 class="text-3xl sm:text-4xl font-extrabold text-accent leading-tight tracking-wider">GESTÃO DE TUTORIA</h1>
<h2 class="text-xl sm:text-2xl text-text-light mt-2 font-light tracking-wider border-b border-gray-700 pb-2 inline-block">AGENDAMENTO DE ATENDIMENTO</h2>
<div class="mt-4">
    <button type="button" onclick="window.location.href='{{ url_for('main.gestao_tutoria') }}'"
            class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">
        VOLTAR PARA O MENU DE TUTORIA
    </button>
</div>
</header>

<main class="w-full max-w-5xl flex-grow">
<form onsubmit="salvarAgendamento(event)" class="bg-dark-secondary p-6 rounded-xl shadow-2xl space-y-6">

<h3 class="text-xl font-bold border-b border-gray-600 pb-2 text-indigo-400">1. Filtros</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label for="filter-tutor" class="block text-sm font-medium mb-1">Tutor:</label>
<select id="filter-tutor" class="form-input" onchange="loadAlunos()"></select>
</div>
<div>
<label for="filter-aluno" class="block text-sm font-medium mb-1">Aluno:</label>
<select id="filter-aluno" class="form-input" onchange="selectAluno()" disabled></select>
</div>
</div>

<h3 class="text-xl font-bold border-b border-gray-600 pb-2 text-indigo-400 pt-4">2. Histórico de Agendamentos</h3>
<div class="overflow-x-auto rounded-lg shadow-lg border border-gray-700">
<table class="min-w-full divide-y divide-gray-700">
<thead class="bg-dark-primary">
<tr>
<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">DATA</th>
<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">TIPO</th>
<th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">DESCRIÇÃO</th>
<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">STATUS</th>
</tr>
</thead>
<tbody id="historico-body" class="bg-dark-secondary divide-y divide-gray-700">
<tr><td colspan="5" class="p-4 text-center text-gray-400">Selecione o aluno para carregar histórico.</td></tr>
</tbody>
</table>
</div>

<h3 class="text-xl font-bold border-b border-gray-600 pb-2 text-indigo-400 pt-4">3. Novo Atendimento</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
<div>
<label for="tipo-atendimento" class="block text-sm font-medium mb-1">Tipo de Atendimento:</label>
<select id="tipo-atendimento" class="form-input" required>
<option value="">Selecione</option>
<option value="Acadêmico">Acadêmico</option>
<option value="Pessoal">Pessoal</option>
<option value="Profissional">Profissional</option>
</select>
</div>
<div>
<label for="status-agendamento" class="block text-sm font-medium mb-1">Status:</label>
<input id="status-agendamento" type="text" class="form-input" disabled value="pendente">
</div>
</div>
<div>
<label for="descricao-atendimento" class="block text-sm font-medium mb-1">Descrição do Atendimento:</label>
<textarea id="descricao-atendimento" rows="4" class="form-input" required></textarea>
</div>

<button type="submit" class="w-full bg-accent hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg mt-2">SALVAR ATENDIMENTO</button>
</form>
</main>
</div>
</body>
</html>