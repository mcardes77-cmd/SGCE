<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ficha de Tutoria do Aluno</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <script type="module">
    import { Timestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    let tutoresData = [];
    let alunosData = [];
    let fichaData = {};

    async function handleFetchResponse(url, context) {
      const response = await fetch(url);
      if (!response.ok) throw new Error(`Falha no fetch de ${context}`);
      return response.json();
    }

    document.addEventListener('DOMContentLoaded', () => loadTutores());

    function formatDate(dateString) {
      if (!dateString) return '';
      const [y, m, d] = dateString.split('-');
      return `${d}/${m}/${y}`;
    }

    // ---- FILTROS ----
    window.loadTutores = async function() {
      const selectTutor = document.getElementById('filter-tutor');
      selectTutor.innerHTML = '<option value="">Carregando tutores...</option>';

      try {
        tutoresData = await handleFetchResponse('/api/tutores', 'Tutores');
        selectTutor.innerHTML = '<option value="">Selecione o(a) Tutor(a)</option>';
        tutoresData.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(t => {
          selectTutor.innerHTML += `<option value="${t.id}">${t.nome}</option>`;
        });
      } catch (e) {
        console.error("Erro ao carregar tutores:", e);
        selectTutor.innerHTML = '<option value="">Erro ao carregar tutores</option>';
      }
    }

    window.loadAlunosPorTutor = async function() {
      const tutorId = document.getElementById('filter-tutor').value;
      const selectAluno = document.getElementById('filter-aluno');
      selectAluno.innerHTML = '<option value="">Selecione o(a) Tutor(a)...</option>';
      selectAluno.disabled = true;

      if (tutorId) {
        try {
          alunosData = await handleFetchResponse(`/api/alunos_por_tutor/${tutorId}`, 'Tutorados');
          selectAluno.innerHTML = '<option value="">Selecione o(a) Tutorado(a)</option>';
          alunosData.sort((a, b) => a.nome.localeCompare(b.nome)).forEach(a => {
            selectAluno.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
          });
          selectAluno.disabled = false;
        } catch (error) {
          console.error("Erro ao carregar alunos:", error);
          selectAluno.innerHTML = '<option value="">Erro ao carregar tutorados</option>';
        }
      } else {
        selectAluno.innerHTML = '<option value="">Selecione o(a) Tutorado(a)</option>';
      }

      document.getElementById('ficha-details-container').classList.add('hidden');
    }

    // ---- FICHA ----
    window.loadAlunoData = async function() {
      const alunoId = document.getElementById('filter-aluno').value;
      const fichaContainer = document.getElementById('ficha-details-container');
      fichaContainer.classList.add('hidden');
      document.getElementById('loading-message').classList.remove('hidden');

      if (!alunoId) {
        document.getElementById('loading-message').textContent = 'Selecione um aluno para carregar a ficha.';
        return;
      }

      try {
        const fichaDataRaw = await handleFetchResponse(`/api/ficha_tutoria/${alunoId}`, 'Ficha de Tutoria');
        fichaData = fichaDataRaw;
        document.getElementById('loading-message').classList.add('hidden');
        renderFicha();
        fichaContainer.classList.remove('hidden');
      } catch (e) {
        console.error("Erro ao carregar ficha:", e);
        document.getElementById('loading-message').textContent = 'Erro ao carregar os dados da ficha.';
      }
    }

    // ---- RENDERIZAÇÃO ----
    window.renderFicha = function() {
      const notasFaltasBody = document.getElementById('notas-faltas-body');
      notasFaltasBody.innerHTML = '';
      (fichaData.disciplinas || []).forEach(disc => {
        notasFaltasBody.innerHTML += `
          <tr class="border-b border-gray-700 hover:bg-dark-secondary/50">
            <td class="p-3 text-sm font-medium">${disc.nome}</td>
            ${(disc.notas || []).map(n => `<td class="p-3"><input type="text" value="${n}" class="form-input p-1 h-8 text-center" disabled></td>`).join('')}
            ${(disc.faltas || []).map(f => `<td class="p-3"><input type="text" value="${f}" class="form-input p-1 h-8 text-center" disabled></td>`).join('')}
          </tr>`;
      });

      const atendimentosBody = document.getElementById('atendimentos-body');
      atendimentosBody.innerHTML = '';
      (fichaData.atendimentos || []).forEach(atend => {
        atendimentosBody.innerHTML += `
          <tr class="border-b border-gray-700 hover:bg-dark-secondary/50">
            <td class="p-3 text-sm">${formatDate(atend.data)}</td>
            <td class="p-3 text-center">${atend.academico ? '✓' : ''}</td>
            <td class="p-3 text-center">${atend.profissional ? '✓' : ''}</td>
            <td class="p-3 text-center">${atend.pessoal ? '✓' : ''}</td>
            <td class="p-3 text-sm">${atend.tutor}</td>
          </tr>`;
      });

      document.getElementById('pv-b1').value = fichaData.projeto_vida?.b1 || '';
      document.getElementById('pv-b2').value = fichaData.projeto_vida?.b2 || '';
      document.getElementById('pv-b3').value = fichaData.projeto_vida?.b3 || '';
      document.getElementById('pv-b4').value = fichaData.projeto_vida?.b4 || '';

      document.getElementById('info-tutorado').textContent = fichaData.aluno_nome || 'N/A';
      document.getElementById('info-tutor').textContent = fichaData.tutor_nome || 'N/A';
      document.getElementById('info-ra').textContent = fichaData.ra || 'N/A';
      document.getElementById('info-sala').textContent = fichaData.sala_nome || 'N/A';
    }

    // ---- SALVAR ATENDIMENTO ----
    window.saveAtendimento = async function() {
      const alunoId = document.getElementById('filter-aluno').value;
      const data = document.getElementById('atendimento-data').value;
      const academico = document.getElementById('eixo-academico').checked;
      const profissional = document.getElementById('eixo-profissional').checked;
      const pessoal = document.getElementById('eixo-pessoal').checked;
      const tutor = document.getElementById('atendimento-tutor').value.trim();

      if (!alunoId || !data || !tutor || (!academico && !profissional && !pessoal)) {
        alert('Preencha a Data, o(a) Tutor(a) e selecione pelo menos um Eixo.');
        return;
      }

      const registro = { aluno_id: alunoId, data, academico, profissional, pessoal, tutor_nome: tutor };

      try {
        const response = await fetch('/api/registrar_atendimento_tutoria', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(registro),
        });
        const result = await response.json().catch(() => ({}));
        if (!response.ok) throw new Error(result.error || response.statusText);
        alert(result.message || 'Atendimento registrado com sucesso!');
        if (fichaData.atendimentos) fichaData.atendimentos.push(registro);
        else fichaData.atendimentos = [registro];
        renderFicha();
      } catch (error) {
        alert(`Erro ao salvar atendimento: ${error.message}`);
      }
    }

  </script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'dark-primary': '#0F172A',
            'dark-secondary': '#1E293B',
            'accent': '#10B981',
            'secondary-accent': '#4F46E5',
            'text-light': '#F8FAFC',
            'danger': '#DC2626',
          },
          fontFamily: { sans: ['Inter', 'sans-serif'] },
        }
      }
    }
  </script>
</head>

<body class="bg-dark-primary text-text-light font-sans min-h-screen">
  <div class="flex flex-col items-center justify-between p-6 md:p-10 min-h-screen">
    <header class="w-full text-center mb-8">
      <h1 class="text-4xl font-extrabold text-secondary-accent">MÓDULO DE GESTÃO DE TUTORIA</h1>
      <h2 class="text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">FICHA DE TUTORIA E PERFIL</h2>
      <div class="mt-4">
        <button onclick="window.location.href='/gestao_tutoria'"
          class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center space-x-2 mx-auto">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 15l-3-3m0 0l3-3m-3 3h8"/></svg>
          <span>VOLTAR PARA O MENU</span>
        </button>
      </div>
    </header>

    <main class="w-full max-w-6xl flex-grow space-y-8">
      <form id="ficha-form" class="bg-dark-secondary p-6 rounded-xl shadow-2xl space-y-6">
        <h3 class="text-xl font-bold border-b border-gray-600 pb-2 text-indigo-400">1. Seleção do Tutor e Aluno</h3>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="filter-tutor" class="block text-sm mb-1">Tutor *:</label>
            <select id="filter-tutor" onchange="loadAlunosPorTutor()" class="w-full p-2 bg-gray-700 rounded">
              <option value="">Selecione o(a) Tutor(a)</option>
            </select>
          </div>

          <div>
            <label for="filter-aluno" class="block text-sm mb-1">Tutorado *:</label>
            <select id="filter-aluno" onchange="loadAlunoData()" disabled class="w-full p-2 bg-gray-700 rounded">
              <option value="">Selecione o(a) Tutorado(a)</option>
            </select>
          </div>
        </div>

        <div id="loading-message" class="text-center text-yellow-500 pt-8 pb-8">
          Selecione um aluno para carregar a ficha.
        </div>

        <!-- O restante (Ficha, Projeto de Vida, Notas, Atendimento) permanece idêntico -->
        <!-- [INCLUA AQUI O MESMO BLOCO DE FICHA QUE VOCÊ JÁ TINHA, SEM MUDANÇAS] -->
      </form>
    </main>

    <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
      <p class="font-medium">DESENVOLVEDOR: MARCELO CARDES E LUIS FELIPE CARDES</p>
      <p class="text-xs font-light">LICENCIADO COMO TESTE PARA E.E. PEI PROFESSORA IRENE DIAS</p>
    </footer>
  </div>
</body>
</html>
