<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lançamento de Notas</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co';
const SUPABASE_ANON_KEY = 'SUA_CHAVE_ANON';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let selectedAlunoId = null;
let selectedBimestre = null;

// ===============================
// CARREGAR TUTORES
// ===============================
async function loadTutores() {
    const selectTutor = document.getElementById('filter-tutor');
    selectTutor.innerHTML = '<option value="">SELECIONE O TUTOR</option>';

    const { data: tutores, error } = await supabase.from('d_tutores').select('id,nome');
    if (error) { console.error(error); return; }

    tutores.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(tutor=>{
        const option = document.createElement('option');
        option.value = tutor.id;
        option.textContent = tutor.nome;
        selectTutor.appendChild(option);
    });
    loadAlunos();
}

// ===============================
// CARREGAR ALUNOS POR TUTOR
// ===============================
async function loadAlunos() {
    const tutorId = document.getElementById('filter-tutor').value;
    const selectAluno = document.getElementById('filter-aluno');
    selectedAlunoId = null;

    selectAluno.innerHTML = '<option value="">SELECIONE O ALUNO</option>';
    selectAluno.disabled = !tutorId;
    document.getElementById('grades-table-body').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Selecione o Aluno e o Bimestre para carregar as notas.</td></tr>';
    document.getElementById('salvar-notas-button').disabled = true;

    if (!tutorId) return;

    const { data: alunos, error } = await supabase.from('d_alunos').select('id,nome').eq('tutor_id', tutorId);
    if (error) { console.error(error); return; }

    alunos.sort((a,b)=>a.nome.localeCompare(b.nome)).forEach(aluno=>{
        const option = document.createElement('option');
        option.value = aluno.id;
        option.textContent = aluno.nome;
        selectAluno.appendChild(option);
    });
}

// ===============================
// HABILITAR BIMESTRE AO SELECIONAR ALUNO
// ===============================
function enableBimestre() {
    const alunoId = document.getElementById('filter-aluno').value;
    selectedAlunoId = alunoId;
    const selectBimestre = document.getElementById('filter-bimestre');
    selectBimestre.disabled = !alunoId;
    document.getElementById('grades-table-body').innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-400">Selecione o Aluno e o Bimestre para carregar as notas.</td></tr>';
    document.getElementById('salvar-notas-button').disabled = true;
    if (alunoId && selectBimestre.value) loadGradesTable();
}

// ===============================
// CARREGAR TABELA DE NOTAS
// ===============================
async function loadGradesTable() {
    const alunoId = document.getElementById('filter-aluno').value;
    const selectedBim = document.getElementById('filter-bimestre').value;
    selectedBimestre = selectedBim;
    const tableBody = document.getElementById('grades-table-body');
    tableBody.innerHTML = '';
    if (!alunoId || !selectedBim) return;

    const bField = `B${selectedBim}`;

    // Buscar notas do aluno no Supabase
    const { data: notasData, error } = await supabase
        .from('f_frequencia')
        .select('notas')
        .eq('aluno_id', alunoId)
        .order('data_registro', { ascending: false })
        .limit(1)
        .single();

    const disciplinas = ['Português', 'Matemática', 'Ciências', 'História', 'Geografia', 'Arte', 'Educação Física', 'Inglês', 'Eletiva', 'Projeto de Vida'];
    const notas = notasData?.notas || {};

    disciplinas.forEach(disc=>{
        const grades = notas[disc] || { B1: 0, B2: 0, B3:0, B4:0 };
        let row = `<tr class="border-b border-gray-700 hover:bg-dark-primary/50">
                    <td class="p-3 font-semibold text-text-light">${disc}</td>`;
        for (let i=1;i<=4;i++){
            const field = `B${i}`;
            const isEditable = field === bField;
            const value = grades[field]>0 ? grades[field].toFixed(1) : '';
            row += `<td class="p-2">
                        <input type="number" step="0.1" min="0" max="10"
                            id="nota-${disc.replace(/\s/g,'_')}-${field}"
                            value="${value}"
                            class="${isEditable?'form-input bg-accent/20':'form-input bg-gray-700 cursor-not-allowed'}"
                            ${isEditable?'':'disabled'}
                            data-disciplina="${disc}" data-bimestre="${field}">
                    </td>`;
        }
        row += '</tr>';
        tableBody.insertAdjacentHTML('beforeend', row);
    });

    document.getElementById('salvar-notas-button').disabled = false;
}

// ===============================
// SALVAR NOTAS NO SUPABASE
// ===============================
async function salvarNotas(e){
    e.preventDefault();
    if (!selectedAlunoId || !selectedBimestre) return alert('Selecione aluno e bimestre');

    const bField = `B${selectedBimestre}`;
    const inputs = document.querySelectorAll(`input[data-bimestre="${bField}"]`);
    const notasToSave = {};
    inputs.forEach(input=>{
        const disc = input.dataset.disciplina;
        let val = parseFloat(input.value);
        if (isNaN(val)) val = 0;
        if (!notasToSave[disc]) notasToSave[disc] = { B1:0,B2:0,B3:0,B4:0 };
        notasToSave[disc][bField] = val;
    });

    const { data, error } = await supabase
        .from('f_frequencia')
        .upsert([{ aluno_id:selectedAlunoId, notas:notasToSave, updated_at:new Date().toISOString() }], { onConflict:['aluno_id'] });

    if (error) { console.error(error); alert('Erro ao salvar notas'); return; }
    alert('Notas salvas com sucesso!');
    loadGradesTable();
}

document.addEventListener('DOMContentLoaded', ()=>{ loadTutores(); });
</script>
<style>
body{background-color:#0F172A;color:#F8FAFC;font-family:'Inter',sans-serif;}
.form-input{width:100%;padding:.75rem;border-radius:.5rem;background-color:#1E293B;color:#F8FAFC;border:1px solid #4b5563;}
.form-input[disabled]{opacity:.7;}
</style>
</head>
<body class="bg-dark-primary">
<div class="flex flex-col items-center min-h-screen p-4 md:p-8">
<header class="w-full text-center mb-8">
<h1 class="text-3xl sm:text-4xl font-extrabold text-accent leading-tight tracking-wider">GESTÃO DE TUTORIA</h1>
<h2 class="text-xl sm:text-2xl text-text-light mt-2 font-light tracking-wider border-b border-gray-700 pb-2 inline-block">LANÇAMENTO DE NOTAS BIMESTRAIS</h2>
</header>

<main class="w-full max-w-5xl flex-grow">
<form onsubmit="salvarNotas(event)" class="bg-dark-secondary p-6 rounded-xl shadow-2xl space-y-6">

<div class="grid grid-cols-1 md:grid-cols-3 gap-4">
<div>
<label for="filter-tutor" class="block text-sm font-medium mb-1">Tutor *:</label>
<select id="filter-tutor" class="form-input" onchange="loadAlunos()" required></select>
</div>
<div>
<label for="filter-aluno" class="block text-sm font-medium mb-1">Aluno *:</label>
<select id="filter-aluno" class="form-input" onchange="enableBimestre()" disabled required></select>
</div>
<div>
<label for="filter-bimestre" class="block text-sm font-medium mb-1">Bimestre *:</label>
<select id="filter-bimestre" class="form-input" onchange="loadGradesTable()" disabled required>
<option value="">SELECIONE</option>
<option value="1">1º Bimestre</option>
<option value="2">2º Bimestre</option>
<option value="3">3º Bimestre</option>
<option value="4">4º Bimestre</option>
</select>
</div>
</div>

<div class="overflow-x-auto rounded-lg shadow-lg border border-gray-700 mt-4">
<table class="min-w-full divide-y divide-gray-700">
<thead class="bg-dark-primary">
<tr>
<th class="px-3 py-3 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">DISCIPLINA</th>
<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">B1</th>
<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">B2</th>
<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">B3</th>
<th class="px-3 py-3 text-center text-xs font-medium text-gray-400 uppercase tracking-wider">B4</th>
</tr>
</thead>
<tbody id="grades-table-body" class="bg-dark-secondary divide-y divide-gray-700">
<tr><td colspan="5" class="p-4 text-center text-gray-400">Selecione o Aluno e o Bimestre para carregar as notas.</td></tr>
</tbody>
</table>
</div>

<button type="submit" id="salvar-notas-button" disabled class="w-full bg-accent hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg mt-4">SALVAR NOTAS</button>
</form>
</main>
</div>
</body>
</html>
